---
title: "Endoderm dox vs no treatment"
output: html_document
---

```{r setup, include=FALSE}
library(pheatmap)
library(edgeR)
library(DESeq2)
library(biomaRt)
library(ggplot2)
sessionInfo()
```
Read in file with read counts.
```{r cars}
filename = "/Users/tfriedrich//Documents/Mattis/endoderm_project/readcounts.txt"
counts1 = read.table(filename, header = T, stringsAsFactors = F) 
rownames(counts1) = counts1$Geneid

```
Reformat.
```{r pressure, echo=FALSE}
counts2 = counts1[,7:ncol(counts1)]
colnames(counts2) = paste( matrix(unlist(strsplit(colnames(counts2), "\\.")), byrow =T, ncol=7)[,3], sub("_1_algn_Aligned", "", matrix(unlist(strsplit(colnames(counts2), "\\.")), byrow =T, ncol=7)[,4]), sep="-")
colnames(counts2)
```
More reformatting.
```{r}
rename = read.table("/Users/tfriedrich/Documents/Mattis/endoderm_project/metadata_Aras_Mattis_2018_08_01v3_Endoderm_dox_config.txt", fill=T, header=T, sep="\t")

renamesample=list()
for (x in 1:nrow(rename)){
  oldname = sub("_1.fq.gz", "", rename$Location[x])
  newname = paste(rename$Name[x], rename$cell.type[x], rename$dox.treatment[x], rename$Genotype[x], sep="_")
  renamesample[oldname] = newname
}
colnames(counts2) = unlist(lapply (colnames(counts2), function(x) renamesample[[x]]))

```
Filter out genes that are too highly expressed or lowly expressed. 
```{r}
keep = rowMeans(counts2) > 5 & rowMeans(counts2) < 5000 
counts3 = counts2[keep,]
```
Take the RPKM.
```{r}
y <- DGEList(counts=counts3)
fpkm_log_matrix = rpkm (y, gene.length=counts1[keep,"Length"], log = FALSE)

```
Dendrogram showing relationships using fpkm. 
```{r}
# 
#par(cex=1,font=3)
hc2 <- hclust(stats::dist(t(fpkm_log_matrix), method="minkowski"), "ward.D2")
#par(mar=c(10, 4, 4, 10), pty='s')
plot(hc2, lwd=4, lty=1, col="black", col.lab="red", xlab="Samples", main="Samples clustered by FPKM using Ward's clustering & Euclidean distance")
```

PCA
```{r}
Condition1 = factor(matrix (unlist(strsplit(colnames(counts3), "_")), byrow=T, ncol=4)[,3], levels = c("No", "Yes"))
Condition2 = factor(matrix (unlist(strsplit(colnames(counts3), "_")), byrow=T, ncol=4)[,4], levels = c("wild-type","NASH pt"))

cold <- data.frame("Condition1"=Condition1, "Condition2"=Condition2) 
rownames(cold) = colnames(counts3)
cold

ddsMat <- DESeq2::DESeqDataSetFromMatrix(countData=counts3, colData=cold, design=~Condition1 + Condition2 );
colnames(ddsMat) <- colnames(counts3)
rld <- DESeq2::rlog(ddsMat) # LOG TRANSFORMED.

```

```{r}
pca              <- prcomp(t(assay(rld)))
#barplot(allPer.vec, main="PCA: % variance explained by each component\n" , ylim=c(0,100), names.arg=allPerLabels.vec)

d <- data.frame(pca$x, group=Condition1, Condition2,  name=colnames(rld)) # returns PC1, PC2, ... PC8... etc
ppp <- ggplot(d, aes_string(x="PC1", y="PC2",shape="Condition2", color="group"))
ppp <- ppp + geom_point(size=6)
plot(ppp)
```
The related samples are messing up clustering. 

Heatmap to see how cells cluster by cell type or experimental condition. 
```{r}
HEATMAP_HEIGHT <- 45 # inchescol
HEATMAP_WIDTH  <- 15
annotation <- data.frame(
  Condition1= Condition1, Condition2=Condition2)
rownames(annotation) <- colnames(fpkm_log_matrix)
pheatmap(fpkm_log_matrix,
         , width=HEATMAP_WIDTH, height=HEATMAP_HEIGHT
         , scale="row"  # actually scale each row
         , clustering_distance_rows="correlation" # or: euclidean
         , clustering_distance_cols="correlation"
         , clustering_method="complete"
         , display_numbers=FALSE
         , border_color="#00000000" # note: the last two digits here are the alpha channel/ transparency
         , show_rownames=FALSE, show_colnames = TRUE
         , annotation = annotation
         , fontsize_row=3.5)
```

Fit the model and estimate dispersion value.
```{r}

design_matrix <- model.matrix( ~ Condition1 + Condition2)
colnames(design_matrix)
design_matrix
y_for_DE <- DGEList(counts=counts3)
y_for_DE <- calcNormFactors(y_for_DE)
y_for_DE = estimateDisp(y_for_DE, design=design_matrix) 
plotBCV(y_for_DE)
fit <- glmFit(y_for_DE, design=design_matrix, dispersion=y_for_DE$trended.dispersion)
```
Tx vs no tx (dox)
```{r}
lrt <- glmLRT(fit, coef = "Condition1Yes")
topTags(lrt)
smoothScatter(x=lrt$table$logFC, y=-log10(lrt$table$PValue))
lrt_table = data.frame(lrt$table, p.adjust(lrt$table$PValue, method = "BH"))
colnames(lrt_table) = c(colnames(lrt$table), "adjPVal_BH")
hist(lrt_table$PValue)

```


Format output into excel sheet. 
```{r}
genes = rownames(counts3)
ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
head(listAttributes(ensembl), 30)
hgnc_swissprot <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol','description'),filters = 'ensembl_gene_id',  values = genes , mart = ensembl)

index = match (genes, hgnc_swissprot$ensembl_gene_id)
results = data.frame(hgnc_swissprot[index,], counts3, fpkm_log_matrix, lrt_table)
colnames(results) = c(
                    colnames(hgnc_swissprot[index,])
                  , unlist(lapply (colnames(counts3), function(x) paste(x, "counts", sep="_")))
                  , unlist(lapply (colnames(fpkm_log_matrix), function(x) paste(x, "fpkm", sep="_")))
                  , unlist(lapply (colnames(lrt_table), function(x) paste(x, "_dox_vs_nodox_baseline", sep="_")))
                  )
curr_date = format(Sys.time(), "%a_%b_%d_%H_hrs_%M_min_%S_sec_%Y")
write.table(results, paste0("~/Documents/Mattis/endoderm_project/mattis_", curr_date, ".xls"), row.names=F, col.names=T, sep="\t")

```